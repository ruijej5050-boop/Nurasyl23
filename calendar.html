<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календарь релизов - Shikimori Calendar - AniMangaHub</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Добавим Shikimori тематику */
        :root {
            --shikimori-pink: #ec4899;
            --shikimori-pink-dark: #db2777;
            --shikimori-purple: #8b5cf6;
        }

        .shikimori-theme .btn-primary {
            background-color: var(--shikimori-pink);
            border-color: var(--shikimori-pink);
        }

        .shikimori-theme .btn-primary:hover {
            background-color: var(--shikimori-pink-dark);
            border-color: var(--shikimori-pink-dark);
        }

        .shikimori-theme .nav-btn:hover {
            background-color: var(--shikimori-pink);
            border-color: var(--shikimori-pink);
        }

        .shikimori-theme .calendar-day.today {
            background-color: rgba(236, 72, 153, 0.1);
            border-color: var(--shikimori-pink);
        }

        .shikimori-badge {
            background-color: var(--shikimori-pink);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .shikimori-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #94a3b8;
        }

        .shikimori-loading i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--shikimori-pink);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background-color: #1e293b;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-online {
            background-color: #10b981;
        }

        .status-offline {
            background-color: #ef4444;
        }

        .shikimori-auth {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }

        .shikimori-auth-icon {
            font-size: 4rem;
            color: var(--shikimori-pink);
            margin-bottom: 20px;
        }

        .shikimori-user-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: #1e293b;
            border-radius: 10px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        .shikimori-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--shikimori-pink);
        }

        .shikimori-user-info h4 {
            color: white;
            margin-bottom: 5px;
        }

        .shikimori-user-info p {
            color: #94a3b8;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="shikimori-theme">
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-play-circle"></i>
                    <span>AniMangaHub</span>
                    <span class="shikimori-badge">Shikimori</span>
                </a>
                
                <nav class="nav-links">
                    <a href="index.html"><i class="fas fa-home"></i> Главная</a>
                    <a href="anime.html"><i class="fas fa-tv"></i> Аниме</a>
                    <a href="manga.html"><i class="fas fa-book"></i> Манга</a>
                    <a href="ranobe.html"><i class="fas fa-book-open"></i> Ранобэ</a>
                    <a href="forum.html"><i class="fas fa-comments"></i> Форум</a>
                    <a href="calendar.html" class="active"><i class="fas fa-calendar-alt"></i> Календарь</a>
                    <a href="collections.html"><i class="fas fa-heart"></i> Коллекции</a>
                </nav>
                
                <div class="user-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Поиск аниме..." id="shikimoriSearch">
                    </div>
                    
                    <a href="notifications.html" class="notification">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="shikimoriNotifications">0</span>
                    </a>
                    
                    <div id="shikimoriAuthButton"></div>
                    
                    <a href="profile.html" class="avatar" id="shikimoriAvatar">
                        <i class="fas fa-user"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-plug"></i> Shikimori API</h3>
                    <div class="api-status">
                        <div class="status-indicator status-online" id="apiStatus"></div>
                        <span id="apiStatusText">Подключение...</span>
                    </div>
                    
                    <div id="shikimoriUserInfo"></div>
                    
                    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="shikimoriLogin()" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Войти через Shikimori
                    </button>
                    
                    <button class="btn btn-outline" style="width: 100%; margin-top: 10px; display: none;" onclick="shikimoriLogout()" id="logoutButton">
                        <i class="fas fa-sign-out-alt"></i> Выйти
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <h3><i class="fas fa-filter"></i> Фильтры календаря</h3>
                    <div class="filter-options" style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="calendar-filter" value="tv" checked onchange="updateCalendar()">
                            <span>ТВ сериалы</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="calendar-filter" value="movie" onchange="updateCalendar()">
                            <span>Фильмы</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="calendar-filter" value="ova" onchange="updateCalendar()">
                            <span>OVA</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" name="calendar-filter" value="ona" onchange="updateCalendar()">
                            <span>ONA</span>
                        </label>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="color: #cbd5e1; margin-bottom: 10px; display: block;">Показывать</label>
                        <select class="filter-select" style="width: 100%;" onchange="updateCalendar()" id="timeFilter">
                            <option value="today">Сегодня</option>
                            <option value="week">Неделя</option>
                            <option value="month">Месяц</option>
                            <option value="all">Все релизы</option>
                        </select>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3><i class="fas fa-cog"></i> Настройки API</h3>
                    <div style="color: #94a3b8; font-size: 0.9rem;">
                        <p><i class="fas fa-database"></i> Лимит запросов: <span id="rateLimit">100</span>/час</p>
                        <p><i class="fas fa-clock"></i> Задержка: <span id="apiDelay">0</span>мс</p>
                    </div>
                    <button class="btn btn-outline" style="width: 100%; margin-top: 10px;" onclick="clearCache()">
                        <i class="fas fa-trash"></i> Очистить кэш
                    </button>
                </div>
            </aside>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- API Authentication -->
                <div id="shikimoriAuthSection" style="display: none;">
                    <section class="shikimori-auth">
                        <div class="shikimori-auth-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h2 style="color: white; margin-bottom: 10px;">Календарь Shikimori</h2>
                        <p style="color: #94a3b8; margin-bottom: 20px;">
                            Войдите через Shikimori.one, чтобы получить доступ к персональному календарю релизов, 
                            синхронизировать ваш список аниме и получать уведомления о новых эпизодах.
                        </p>
                        <button class="btn btn-primary" onclick="shikimoriLogin()">
                            <i class="fas fa-sign-in-alt"></i> Войти через Shikimori
                        </button>
                        <p style="color: #64748b; margin-top: 15px; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Мы используем официальный API Shikimori.one
                        </p>
                    </section>
                </div>
                
                <!-- Calendar Content -->
                                   <section class="manga-reader-preview">
    <iframe 
        src="https://animego.studio/ongoing/"
        style="width:100%; height:80vh; border:none; border-radius:12px;"
        loading="lazy">
    </iframe>
</section>
                   
                    <section class="calendar-container" id="calendarContainer" style="display: none;">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar will be generated dynamically -->
                        </div>
                    </section>
                    
                    <!-- Upcoming Releases -->
                    <section class="upcoming-releases" id="upcomingReleases" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-clock" style="color: var(--shikimori-pink);"></i> Ближайшие релизы
                            </h2>
                            <a href="#" class="view-all" onclick="loadMoreReleases()">
                                Показать больше <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                        
                        <div class="release-list" id="releaseList">
                            <!-- Releases will be loaded dynamically -->
                        </div>
                    </section>
                    
                    <!-- User's Anime List -->
                    <section class="section" id="userAnimeSection" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-heart" style="color: var(--shikimori-pink);"></i> Мое аниме
                            </h2>
                            <div style="display: flex; gap: 10px;">
                                <select class="filter-select" id="listStatusFilter" onchange="filterUserList()">
                                    <option value="all">Все статусы</option>
                                    <option value="watching">Смотрю</option>
                                    <option value="planned">В планах</option>
                                    <option value="completed">Просмотрено</option>
                                    <option value="dropped">Брошено</option>
                                </select>
                                <button class="btn btn-outline" onclick="refreshUserList()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="anime-grid" id="userAnimeList">
                            <!-- User's anime will be loaded here -->
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>AniMangaHub × Shikimori</h3>
                    <p>Интегрировано с Shikimori.one API для актуальной информации об аниме.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-vk"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                        <a href="https://shikimori.one" target="_blank">
                            <i class="fas fa-external-link-alt"></i> Shikimori
                        </a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h3>Shikimori API</h3>
                    <ul class="footer-links">
                        <li><a href="https://shikimori.one/api/doc" target="_blank">Документация API</a></li>
                        <li><a href="https://shikimori.one/oauth" target="_blank">OAuth авторизация</a></li>
                        <li><a href="https://shikimori.one/forum" target="_blank">Форум Shikimori</a></li>
                        <li><a href="https://github.com/shikimori" target="_blank">GitHub</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Помощь</h3>
                    <ul class="footer-links">
                        <li><a href="faq.html">FAQ по API</a></li>
                        <li><a href="api-guide.html">Руководство по API</a></li>
                        <li><a href="rate-limits.html">Лимиты запросов</a></li>
                        <li><a href="contact.html">Контакты</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Проект</h3>
                    <ul class="footer-links">
                        <li><a href="https://github.com/yourusername/anime-website" target="_blank">Исходный код</a></li>
                        <li><a href="changelog.html">История изменений</a></li>
                        <li><a href="contributing.html">Вклад в проект</a></li>
                        <li><a href="donate.html">Поддержать проект</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2023 AniMangaHub. Использует Shikimori.one API.
                <br>
                <small style="color: #64748b;">
                    Shikimori.one не несет ответственности за содержимое этого сайта.
                    Все данные об аниме предоставляются сообществом Shikimori.
                </small>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div class="modal" id="animeDetailModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Детали аниме</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Anime details will be loaded here -->
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/shikimori-api.js"></script>
    <script>
        // Calendar with Shikimori API
        let currentWeekOffset = 0;
        let calendarData = [];
        let userAnimeList = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check API status
            checkAPIStatus();
            
            // Update auth UI
            updateAuthUI();
            
            // Load popular anime
            loadPopularAnime();
            
            // Load calendar
            loadCalendar();
            
            // Set up search
            setupSearch();
        });

        async function checkAPIStatus() {
            const statusIndicator = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            try {
                // Try to make a simple request to check API status
                const response = await fetch('https://shikimori.one/api/animes?limit=1');
                
                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'API доступен';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'API недоступен';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Нет соединения';
            }
        }

        function updateAuthUI() {
            const isAuthenticated = shikimoriAPI.isAuthenticated();
            const authSection = document.getElementById('shikimoriAuthSection');
            const calendarContent = document.getElementById('calendarContent');
            const loginButton = document.getElementById('loginButton');
            const logoutButton = document.getElementById('logoutButton');
            const authButtonContainer = document.getElementById('shikimoriAuthButton');
            const userInfoContainer = document.getElementById('shikimoriUserInfo');
            
            if (isAuthenticated) {
                authSection.style.display = 'none';
                calendarContent.style.display = 'block';
                loginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                
                // Show user info
                const userData = JSON.parse(localStorage.getItem('shikimori_user') || '{}');
                userInfoContainer.innerHTML = `
                    <div class="shikimori-user-card">
                        <img src="${userData.avatar || 'https://via.placeholder.com/60'}" 
                             alt="${userData.nickname}" class="shikimori-avatar">
                        <div class="shikimori-user-info">
                            <h4>${userData.nickname}</h4>
                            <p>Уровень: ${userData.level || 1}</p>
                        </div>
                    </div>
                `;
                
                // Update avatar in header
                const avatar = document.getElementById('shikimoriAvatar');
                avatar.innerHTML = `<img src="${userData.avatar || '#'}" alt="${userData.nickname}" style="width: 100%; height: 100%; border-radius: 50%;">`;
                
                // Load user's anime list
                loadUserAnimeList();
            } else {
                authSection.style.display = 'block';
                calendarContent.style.display = 'none';
                loginButton.style.display = 'block';
                logoutButton.style.display = 'none';
                userInfoContainer.innerHTML = '';
                
                // Reset avatar
                const avatar = document.getElementById('shikimoriAvatar');
                avatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        function shikimoriLogin() {
            // В реальном приложении нужно использовать OAuth2 flow
            // Для демонстрации используем имитацию
            
            // Сохраняем тестовые данные
            const testUser = {
                id: 12345,
                nickname: 'AnimeFan',
                avatar: 'https://via.placeholder.com/150',
                level: 15
            };
            
            localStorage.setItem('shikimori_token', 'test_token_123');
            localStorage.setItem('shikimori_user_id', testUser.id);
            localStorage.setItem('shikimori_user', JSON.stringify(testUser));
            
            // Обновляем API объект
            shikimoriAPI.accessToken = 'test_token_123';
            shikimoriAPI.userId = testUser.id;
            
            updateAuthUI();
            alert('Демо-авторизация успешна! В реальном приложении будет использоваться OAuth Shikimori.');
        }

        function shikimoriLogout() {
            shikimoriAPI.logout();
            updateAuthUI();
            alert('Вы вышли из системы');
        }

        async function loadPopularAnime() {
            const container = document.getElementById('popularAnimeList');
            
            try {
                const animeList = await shikimoriAPI.getPopularAnime();
                
                container.innerHTML = '';
                animeList.slice(0, 5).forEach(anime => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'sidebar-links';
                    item.style.display = 'block';
                    item.style.padding = '8px 10px';
                    item.style.borderRadius = '6px';
                    item.style.marginBottom = '5px';
                    item.style.color = '#cbd5e1';
                    item.style.textDecoration = 'none';
                    item.style.transition = 'all 0.3s';
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${ShikimoriUtils.getPoster(anime, 'small')}" 
                                 alt="${anime.russian || anime.name}"
                                 style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;">
                            <div>
                                <div style="color: white; font-weight: 500; font-size: 0.9rem;">
                                    ${(anime.russian || anime.name).substring(0, 20)}${(anime.russian || anime.name).length > 20 ? '...' : ''}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    ${anime.score || 'N/A'} ★ • ${anime.episodes || '?'} эп.
                                </div>
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        showAnimeDetails(anime.id);
                    });
                    
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#334155';
                    });
                    
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                    });
                    
                    container.appendChild(item);
                });
            } catch (error) {
                container.innerHTML = `
                    <div style="color: #94a3b8; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div style="margin-top: 10px;">Не удалось загрузить популярное аниме</div>
                    </div>
                `;
            }
        }

        async function loadCalendar() {
            const loading = document.getElementById('calendarLoading');
            const container = document.getElementById('calendarContainer');
            const releasesSection = document.getElementById('upcomingReleases');
            const releaseList = document.getElementById('releaseList');
            const stats = document.getElementById('calendarStats');
            
            loading.style.display = 'flex';
            container.style.display = 'none';
            releasesSection.style.display = 'none';
            
            try {
                // Get calendar data
                const calendar = await shikimoriAPI.getCalendar();
                calendarData = calendar;
                
                // Update stats
                stats.textContent = `${calendar.length} релизов`;
                
                // Generate calendar grid
                generateCalendarGrid();
                
                // Load upcoming releases
                loadUpcomingReleases();
                
                loading.style.display = 'none';
                container.style.display = 'block';
                releasesSection.style.display = 'block';
                
            } catch (error) {
                loading.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Ошибка загрузки</h3>
                        <p style="color: #94a3b8;">Не удалось загрузить календарь релизов</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="loadCalendar()">
                            <i class="fas fa-sync-alt"></i> Повторить
                        </button>
                    </div>
                `;
            }
        }

        function generateCalendarGrid() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Add day headers
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            // Calculate week range
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() + (currentWeekOffset * 7) - today.getDay() + 1);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            // Update week range display
            const weekRange = document.getElementById('currentWeekRange');
            weekRange.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            
            // Generate 7 days (Monday to Sunday)
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Check if today
                const isToday = currentDate.toDateString() === today.toDateString();
                if (isToday) {
                    dayElement.classList.add('today');
                }
                
                // Get releases for this day
                const dayReleases = getReleasesForDate(currentDate);
                
                // Day number
                const dayNumber = document.createElement('div');
                dayNumber.className = `day-number ${isToday ? 'today' : ''}`;
                dayNumber.textContent = currentDate.getDate();
                dayElement.appendChild(dayNumber);
                
                // Releases for this day
                if (dayReleases.length > 0) {
                    const releasesContainer = document.createElement('div');
                    releasesContainer.className = 'release-items';
                    
                    dayReleases.slice(0, 3).forEach(release => {
                        const releaseElement = ShikimoriUtils.createCalendarItem(release);
                        releasesContainer.appendChild(releaseElement);
                    });
                    
                    if (dayReleases.length > 3) {
                        const moreElement = document.createElement('div');
                        moreElement.className = 'release-more';
                        moreElement.textContent = `+${dayReleases.length - 3} еще`;
                        moreElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            showDayReleases(currentDate, dayReleases);
                        });
                        releasesContainer.appendChild(moreElement);
                    }
                    
                    dayElement.appendChild(releasesContainer);
                }
                
                grid.appendChild(dayElement);
            }
        }

        function getReleasesForDate(date) {
            if (!calendarData || !calendarData.length) return [];
            
            const dateString = date.toISOString().split('T')[0];
            
            return calendarData.filter(release => {
                if (!release.next_episode_at) return false;
                
                const releaseDate = new Date(release.next_episode_at);
                const releaseDateString = releaseDate.toISOString().split('T')[0];
                
                return releaseDateString === dateString;
            });
        }

        async function loadUpcomingReleases() {
            const releaseList = document.getElementById('releaseList');
            releaseList.innerHTML = '';
            
            // Get today and tomorrow
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            // Filter releases for today and tomorrow
            const upcomingReleases = calendarData.filter(release => {
                if (!release.next_episode_at) return false;
                
                const releaseDate = new Date(release.next_episode_at);
                const releaseDateString = releaseDate.toISOString().split('T')[0];
                const todayString = today.toISOString().split('T')[0];
                const tomorrowString = tomorrow.toISOString().split('T')[0];
                
                return releaseDateString === todayString || releaseDateString === tomorrowString;
            }).sort((a, b) => {
                return new Date(a.next_episode_at) - new Date(b.next_episode_at);
            });
            
            // Create release cards
            upcomingReleases.forEach(release => {
                const card = createReleaseCard(release);
                releaseList.appendChild(card);
            });
        }

        function createReleaseCard(release) {
            const card = document.createElement('div');
            card.className = 'release-card';
            
            const anime = release.anime;
            const episode = release.episode;
            const nextEpisodeAt = release.next_episode_at;
            
            const time = nextEpisodeAt ? 
                new Date(nextEpisodeAt).toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) : 'Время неизвестно';
            
            const date = nextEpisodeAt ? 
                new Date(nextEpisodeAt).toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'short'
                }) : '';
            
            card.innerHTML = `
                <div class="release-header">
                    <div>
                        <h3 class="release-title">${anime?.russian || anime?.name || 'Неизвестное аниме'}</h3>
                        <div class="release-meta">
                            <span class="release-type type-anime">Эпизод ${episode}</span>
                            <span><i class="far fa-clock"></i> ${date} ${time}</span>
                            <span><i class="fas fa-tv"></i> ${ShikimoriUtils.getTypeText(anime?.kind)}</span>
                        </div>
                    </div>
                    <div class="release-time">${time}</div>
                </div>
                <div class="release-footer">
                    <div>
                        <i class="fas fa-star"></i> ${anime?.score || 'N/A'} ★
                        <span style="margin-left: 15px;">
                            <i class="fas fa-play-circle"></i> ${anime?.episodes_aired || 0}/${anime?.episodes || '?'}
                        </span>
                    </div>
                    <button class="reminder-btn" onclick="toggleReminder(event, '${release.id}')">
                        <i class="far fa-bell"></i> Напомнить
                    </button>
                </div>
            `;
            
            card.addEventListener('click', function() {
                if (anime) {
                    showAnimeDetails(anime.id);
                }
            });
            
            return card;
        }

        async function loadUserAnimeList() {
            const container = document.getElementById('userAnimeList');
            const section = document.getElementById('userAnimeSection');
            
            if (!shikimoriAPI.isAuthenticated()) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = `
                <div class="shikimori-loading">
                    <i class="fas fa-spinner"></i>
                    <span>Загрузка вашего списка...</span>
                </div>
            `;
            
            try {
                userAnimeList = await shikimoriAPI.getUserAnimeList();
                
                if (userAnimeList.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #94a3b8; width: 100%;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h3 style="color: white; margin-bottom: 10px;">Список аниме пуст</h3>
                            <p>Добавьте аниме в свой список на Shikimori</p>
                        </div>
                    `;
                    return;
                }
                
                filterUserList();
                
            } catch (error) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444; width: 100%;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Ошибка загрузки</h3>
                        <p>Не удалось загрузить ваш список аниме</p>
                    </div>
                `;
            }
        }

        function filterUserList() {
            const container = document.getElementById('userAnimeList');
            const statusFilter = document.getElementById('listStatusFilter').value;
            
            if (!userAnimeList || userAnimeList.length === 0) return;
            
            const filteredList = statusFilter === 'all' 
                ? userAnimeList 
                : userAnimeList.filter(item => item.status === statusFilter);
            
            container.innerHTML = '';
            
            filteredList.slice(0, 8).forEach(item => {
                const anime = item.anime;
                if (!anime) return;
                
                const card = ShikimoriUtils.createAnimeCard(anime);
                
                // Add user-specific info
                const userInfo = document.createElement('div');
                userInfo.style.marginTop = '10px';
                userInfo.style.fontSize = '0.85rem';
                userInfo.style.color = '#94a3b8';
                
                const statusText = {
                    'watching': 'Смотрю',
                    'planned': 'В планах',
                    'completed': 'Просмотрено',
                    'dropped': 'Брошено'
                }[item.status] || item.status;
                
                userInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${statusText}</span>
                        <span>${item.episodes || 0}/${anime.episodes || '?'} эп.</span>
                    </div>
                    ${item.score ? `<div style="margin-top: 5px;">Оценка: ${item.score} ★</div>` : ''}
                `;
                
                card.querySelector('.card-content').appendChild(userInfo);
                container.appendChild(card);
            });
            
            if (filteredList.length > 8) {
                const showMore = document.createElement('div');
                showMore.style.textAlign = 'center';
                showMore.style.marginTop = '20px';
                
                const button = document.createElement('button');
                button.className = 'btn btn-outline';
                button.textContent = 'Показать все';
                button.addEventListener('click', function() {
                    // В реальном приложении загрузить больше или открыть полный список
                    alert(`Всего аниме в списке: ${filteredList.length}`);
                });
                
                showMore.appendChild(button);
                container.appendChild(showMore);
            }
        }

        function refreshUserList() {
            loadUserAnimeList();
        }

        function previousWeek() {
            currentWeekOffset--;
            generateCalendarGrid();
        }

        function nextWeek() {
            currentWeekOffset++;
            generateCalendarGrid();
        }

        function goToToday() {
            currentWeekOffset = 0;
            generateCalendarGrid();
            
            // Scroll to today
            const todayElement = document.querySelector('.calendar-day.today');
            if (todayElement) {
                todayElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateCalendar() {
            generateCalendarGrid();
        }

        function loadMoreReleases() {
            // В реальном приложении загрузить больше релизов
            alert('Функция загрузки дополнительных релизов в разработке');
        }

        function setupSearch() {
            const searchInput = document.getElementById('shikimoriSearch');
            
            searchInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        try {
                            const results = await shikimoriAPI.searchAnime(query);
                            showSearchResults(results);
                        } catch (error) {
                            alert('Ошибка поиска: ' + error.message);
                        }
                    }
                }
            });
        }

        function showSearchResults(results) {
            const modal = document.getElementById('animeDetailModal');
            const body = document.getElementById('modalBody');
            
            modal.style.display = 'flex';
            
            if (results.length === 0) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #94a3b8; margin-bottom: 20px;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Ничего не найдено</h3>
                        <p style="color: #94a3b8;">Попробуйте изменить запрос</p>
                    </div>
                `;
                return;
            }
            
            body.innerHTML = `
                <h4 style="color: white; margin-bottom: 20px;">Результаты поиска (${results.length})</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                    ${results.map(anime => `
                        <div class="anime-card" onclick="showAnimeDetails(${anime.id})" style="cursor: pointer;">
                            <img src="${ShikimoriUtils.getPoster(anime, 'medium')}" 
                                 alt="${anime.russian || anime.name}" 
                                 style="width: 100%; height: 250px; object-fit: cover; border-radius: 8px;">
                            <div style="padding: 10px;">
                                <h5 style="color: white; margin-bottom: 5px; font-size: 0.9rem;">
                                    ${(anime.russian || anime.name).substring(0, 30)}${(anime.russian || anime.name).length > 30 ? '...' : ''}
                                </h5>
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    ${anime.score || 'N/A'} ★ • ${anime.episodes || '?'} эп.
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function showAnimeDetails(animeId) {
            const modal = document.getElementById('animeDetailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            modal.style.display = 'flex';
            body.innerHTML = `
                <div class="shikimori-loading">
                    <i class="fas fa-spinner"></i>
                    <span>Загрузка информации...</span>
                </div>
            `;
            
            try {
                const anime = await shikimoriAPI.getAnimeById(animeId);
                const screenshots = await shikimoriAPI.getScreenshots(animeId);
                
                title.textContent = anime.russian || anime.name;
                
                body.innerHTML = `
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                        <img src="${ShikimoriUtils.getPoster(anime, 'large')}" 
                             alt="${anime.russian || anime.name}"
                             style="width: 200px; height: 300px; object-fit: cover; border-radius: 8px;">
                        
                        <div style="flex: 1; min-width: 300px;">
                            <h4 style="color: white; margin-bottom: 10px;">${anime.russian || anime.name}</h4>
                            <div style="color: #94a3b8; margin-bottom: 15px;">${anime.japanese || ''}</div>
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                                <div style="background-color: var(--shikimori-pink); color: white; padding: 5px 10px; border-radius: 4px;">
                                    ${ShikimoriUtils.getTypeText(anime.kind)}
                                </div>
                                <div style="color: #94a3b8;">
                                    <i class="fas fa-star" style="color: #f59e0b;"></i> ${anime.score || 'N/A'}
                                </div>
                                <div style="color: #94a3b8;">
                                    <i class="fas fa-play-circle"></i> ${anime.episodes || '?'} эпизодов
                                </div>
                                <div style="color: ${ShikimoriUtils.getStatusColor(anime.status)};">
                                    ${ShikimoriUtils.getStatusText(anime.status)}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <div style="color: white; margin-bottom: 5px;">Жанры:</div>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${(anime.genres || []).map(genre => `
                                        <span class="tag">${genre.russian || genre.name}</span>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <div style="color: white; margin-bottom: 5px;">Статус:</div>
                                <div style="color: #94a3b8;">${anime.aired_on ? 'С ' + anime.aired_on : 'Дата выхода неизвестна'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="color: white; margin-bottom: 10px;">Описание:</div>
                        <div style="color: #94a3b8; line-height: 1.6;">${anime.description || 'Описание отсутствует'}</div>
                    </div>
                    
                    ${screenshots.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <div style="color: white; margin-bottom: 10px;">Скриншоты (${screenshots.length}):</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                                ${screenshots.slice(0, 4).map(screenshot => `
                                    <img src="${screenshot.original}" 
                                         alt="Screenshot"
                                         style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                         onclick="openImage('${screenshot.original}')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${shikimoriAPI.isAuthenticated() ? `
                            <button class="btn btn-primary" onclick="addToUserList(${anime.id})">
                                <i class="fas fa-plus"></i> Добавить в список
                            </button>
                        ` : ''}
                        <button class="btn btn-outline" onclick="window.open('https://shikimori.one${anime.url}', '_blank')">
                            <i class="fas fa-external-link-alt"></i> Открыть на Shikimori
                        </button>
                    </div>
                `;
                
            } catch (error) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Ошибка загрузки</h3>
                        <p style="color: #94a3b8;">Не удалось загрузить информацию об аниме</p>
                    </div>
                `;
            }
        }

        async function addToUserList(animeId) {
            if (!shikimoriAPI.isAuthenticated()) {
                alert('Пожалуйста, войдите в систему');
                return;
            }
            
            try {
                await shikimoriAPI.addToUserList(animeId, 'planned');
                alert('Аниме добавлено в ваш список на Shikimori!');
                loadUserAnimeList(); // Обновить список
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        function showDayReleases(date, releases) {
            const modal = document.getElementById('animeDetailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            const dateString = date.toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            title.textContent = `Релизы на ${dateString}`;
            
            if (releases.length === 0) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-calendar" style="font-size: 3rem; color: #94a3b8; margin-bottom: 20px;"></i>
                        <h3 style="color: white; margin-bottom: 10px;">Нет релизов</h3>
                        <p style="color: #94a3b8;">На эту дату не запланировано выходов аниме</p>
                    </div>
                `;
            } else {
                body.innerHTML = `
                    <h4 style="color: white; margin-bottom: 20px;">${releases.length} релизов</h4>
                    <div class="release-list">
                        ${releases.map(release => {
                            const anime = release.anime;
                            const time = release.next_episode_at ? 
                                new Date(release.next_episode_at).toLocaleTimeString('ru-RU', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                }) : 'Время неизвестно';
                            
                            return `
                                <div class="release-card" onclick="showAnimeDetails(${anime?.id})">
                                    <div class="release-header">
                                        <div>
                                            <h3 class="release-title">${anime?.russian || anime?.name || 'Неизвестное аниме'}</h3>
                                            <div class="release-meta">
                                                <span class="release-type type-anime">Эпизод ${release.episode}</span>
                                                <span><i class="far fa-clock"></i> ${time}</span>
                                                <span><i class="fas fa-tv"></i> ${ShikimoriUtils.getTypeText(anime?.kind)}</span>
                                            </div>
                                        </div>
                                        <div class="release-time">${time}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function toggleReminder(event, releaseId) {
            event.stopPropagation();
            
            if (!shikimoriAPI.isAuthenticated()) {
                alert('Войдите в систему, чтобы устанавливать напоминания');
                return;
            }
            
            const button = event.target.closest('.reminder-btn');
            const isSet = button.classList.contains('active');
            
            if (isSet) {
                button.classList.remove('active');
                button.innerHTML = '<i class="far fa-bell"></i> Напомнить';
                alert('Напоминание удалено');
            } else {
                button.classList.add('active');
                button.innerHTML = '<i class="fas fa-bell"></i> Напоминание установлено';
                alert('Напоминание установлено! Вы получите уведомление за час до выхода эпизода.');
            }
            
            // Сохранить в localStorage
            localStorage.setItem(`reminder_${releaseId}`, !isSet);
        }

        function closeModal() {
            document.getElementById('animeDetailModal').style.display = 'none';
        }

        function openImage(url) {
            window.open(url, '_blank');
        }

        function clearCache() {
            // Очистить кэш API запросов
            const keys = Object.keys(localStorage).filter(key => 
                key.startsWith('shikimori_cache_')
            );
            
            keys.forEach(key => localStorage.removeItem(key));
            
            alert('Кэш очищен');
        }

        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short'
            });
        }

        // Close modal when clicking outside
        document.getElementById('animeDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>